version: '3.9'

services:
  stakeholders-service:
    build:
      dockerfile: Dockerfile
      context: ./stakeholders-service
      target: final
    restart: on-failure
    networks:
      - database
    ports:
      - "5001:5001"
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - DATABASE_HOST=stakeholders-db
      - DATABASE_PORT=5432
      - DATABASE_PASSWORD=super
      - DATABASE_USER=postgres
      - DATABASE_SCHEMA=stakeholdersdb
    depends_on:
      - stakeholders-db

  stakeholders-db:
    image: postgres:13
    restart: always
    networks:
      - database
    environment:
      POSTGRES_PASSWORD: super
      POSTGRES_USER: postgres
      POSTGRES_DB: stakeholdersdb
    volumes:
      - type: volume
        source: stakeholdersdb
        target: /var/lib/postgresql/data
      - type: bind
        source: stakeholders-service/stakeholders-init-data.sql
        target: /docker-entrypoint-initdb.d/stakeholders-init-data.sql
    ports:
      - "5432:5432"

  #blog-service:
  #  build:
  #    context: ./blog-service
  #  restart: on-failure
  #  networks:
  #    - database
  #  ports:
  #    - "8081:8080"
  #  environment:
  #    - BLOG_SERVICE_PORT=8080
  #    - BLOG_DB_HOST=blog-db
  #    - BLOG_DB_PORT=5432
  #    - BLOG_DB_NAME=blogdb
  #    - BLOG_DB_USER=postgres
  #    - BLOG_DB_PASS=super
  #  volumes:
  #    - blog-uploads:/app/uploads
  #  depends_on:
  #    - blog-db

  #blog-db:
  #  image: postgres:13
  #  restart: always
  #  networks:
  #    - database
  #  environment:
  #    POSTGRES_PASSWORD: super
  #    POSTGRES_USER: postgres
  #    POSTGRES_DB: blogdb
  #  volumes:
  #    - type: volume
  #      source: blogdb
  #      target: /var/lib/postgresql/data



  blog-db:
    image: mongo:7
    restart: always
    networks:
      - database
    ports:
      - "27017:27017"
    volumes:
      - blogmongo:/data/db

  blog-service:
    build:
      context: ./blog-service
    restart: on-failure
    networks:
      - database
    ports:
      - "8081:8080"
    environment:
      - BLOG_SERVICE_PORT=8080
      - MONGO_URI=mongodb://blog-db:27017
      - MONGO_DB=blogdb
    volumes:
      - blog-uploads:/app/uploads
    depends_on:
      - blog-db

  api-gateway:
    build: ./api-gateway
    ports:
      - "8090:8090"
    environment:
      - STAKEHOLDERS_SERVICE_ADDRESS=stakeholders-service:5001
      - GATEWAY_ADDRESS=:8090
    depends_on:
      - stakeholders-service
      - blog-service
    networks:
      - database
  # üîπ NEW: Tours Service (API)
  tours-service:
    build:
      dockerfile:  ./tours-service/Dockerfile
      context: .
      target: final
    restart: on-failure
    networks:
      - database
    ports:
      - "8082:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - DATABASE_HOST=tours-db
      - DATABASE_PORT=5432
      - DATABASE_PASSWORD=super
      - DATABASE_USER=postgres
      - DATABASE_NAME=toursdb
    depends_on:
      - tours-db

  # üîπ NEW: Tours Database
  tours-db:
    image: postgres:13
    restart: always
    networks:
      - database
    environment:
      POSTGRES_PASSWORD: super
      POSTGRES_USER: postgres
      POSTGRES_DB: toursdb
    volumes:
      - type: volume
        source: toursdb
        target: /var/lib/postgresql/data

  #followers
  neo4j-db:
    image: neo4j:5
    restart: always
    networks: [database]
    environment:
      NEO4J_AUTH: "neo4j/neo4jpass"
    ports:
      - "7474:7474"   # Neo4j Browser
      - "7687:7687"   # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
      - neo4j_import:/import
    healthcheck:
      test: ["CMD", "cypher-shell", "-a", "bolt://localhost:7687", "-u", "neo4j", "-p", "neo4jpass", "RETURN 1;"]
      interval: 5s
      timeout: 5s
      retries: 30

  followers-service:
    build:
      context: ./followers-service
      dockerfile: Dockerfile
      target: final
    restart: on-failure
    networks: [database]
    ports:
      - "8083:8085"   # host:container
    environment:
      NEO4J_URI: "bolt://neo4j-db:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "neo4jpass"      
      CORS_ORIGIN: "http://localhost:4200"
    depends_on:
      neo4j-db:
        condition: service_healthy
  # --- TRACING (Jaeger sa ukljuƒçenim Zipkin endpointom) ---
  jaeger:
    image: jaegertracing/all-in-one:latest
    networks: [database]
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411   # <-- obavezno, pali Zipkin
    ports:
      - "16686:16686"  # Jaeger UI
      - "9411:9411"    # Zipkin endpoint
    # (nije potrebno mapirati 4317/4318 za ovu varijantu)

  # --- METRIKE ---
  prometheus:
    image: prom/prometheus:latest
    networks: [database]
    ports: ["9090:9090"]
    volumes:
      - ./observability/prometheus-windows.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana:latest
    networks: [database]
    ports: ["3000:3000"]
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: cadvisor
    privileged: true
    cgroup: host                    # ‚Üê KLJUƒåNO: vidi sve cgroup-ove (sve kontejnere)
    volumes:
      - /:/rootfs:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /sys:/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /run/containerd/containerd.sock:/run/containerd/containerd.sock:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    ports:
      - "8084:8080"
    restart: unless-stopped
    networks: [database]

  telegraf:
    image: telegraf:1.31
    container_name: telegraf
    restart: unless-stopped
    networks: [database]
    ports:
      - "9273:9273"                # Prometheus /metrics endpoint
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./observability/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro




volumes:
  stakeholdersdb:
    name: stakeholdersdb
  blogdb:
    name: blogdb
  blog-uploads:
    name: blog-uploads
  toursdb:
    name: toursdb
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  neo4j_import:
  blogmongo:

networks:
  database:
    name: database
    driver: bridge
